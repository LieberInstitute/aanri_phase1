#!/bin/bash
## Author: Kynon J Benjamin
##
## This script adds residualized expression to CpG text file generated by
## extract_methyl.R.
##
## Input: Features, phenotype information, residualized expression, and
## directory with CpG text files.
##
## Output: New CSV text file with residualized expression added.

PHENO_FILE="/path/to/phenotypes/merged_phenotypes.csv"
GENE_FILES="/path/to/cpg/per/feature/"
FEATURE="../../_m/degs_annotation.txt"

for TISSUE in 'caudate' 'dlpfc'; do
    mkdir $TISSUE
    EXPR_FILE="../../../differential_analysis/${TISSUE}/_m/genes/residualized_expression.tsv"
    CPG_DIR="../../_m/${TISSUE}"
    grep $TISSUE $FEATURE | while read -r PARAM; do
        GNAME=`echo $PARAM | awk '{print $1}' `
        ii=`echo $GNAME | sed 's/\./_/' `
        # echo $TISSUE $GNAME $CHR $P0 $P1
        qsub -V -N prepDNAm_${ii} -o $TISSUE/${ii}.log -e $TISSUE/${ii}.log -cwd \
             -b y "export OPENBLAS_NUM_THREADS=1; \
                  python ../_h/prep_methylation.py \
                         --gene_file $GENE_FILES/$TISSUE/$GNAME \
                         --dirname $TISSUE/$ii --pheno_file $PHENO_FILE \
                         --expr_file $EXPR_FILE --cpg_dir $CPG_DIR"
    done
done
