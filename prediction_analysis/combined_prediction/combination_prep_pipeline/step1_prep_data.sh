#!/bin/bash
## Author: Kynon J Benjamin
##
## This script adds residualized expression to CpG text file generated by
## extract_methyl.R.
##
## Input: Features, phenotype information, residualized expression, and
## directory with CpG text files.
##
## Output: New CSV text file with residualized expression added.

PHENO_FILE="/path/to/phenotypes/merged_phenotypes.csv"
GENE_FILES="/path/to/cpg/per/feature/"
FEATURE="../../_m/degs_annotation.txt"

GENE_FILES="../../../methyl_prediction/extract_methyl_predgenes/_m"

for TISSUE in 'caudate' 'dlpfc'; do
    mkdir $TISSUE
    EXPR_FILE="../../../differential_analysis/${TISSUE}/_m/genes/residualized_expression.tsv"
    CPG_DIR="../../methyl_prediction/extract_methyl_predgenes/prep_input/_m/${TISSUE}"
    SNP_DIR="../../snp_prediction/extract_snps_predgenes/onehot_encode/_m/${TISSUE}"
    ls -d $GENE_FILES/$TISSUE/ENSG00000*/ | while read -r GNAME; do
        ii=`basename $GNAME | sed 's/\./_/'`
        qsub -V -N prepMix_${ii} -o $TISSUE/${ii}.log -e $TISSUE/${ii}.log -cwd \
             -b y "export OPENBLAS_NUM_THREADS=1; \
                   python ../_h/prep_data.py \
                          --gene_file $GENE_FILES/$TISSUE/$GNAME \
                          --dirname $TISSUE/$ii --pheno_file $PHENO_FILE \
                          --expr_file $EXPR_FILE --cpg_dir $CPG_DIR \
                          --snp_dir $SNP_DIR"
    done
done
